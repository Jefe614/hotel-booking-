{% extends 'base.html' %}

{% block title %}Complete Payment | Bava Restaurant{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-6">
        <div class="card shadow">
            <div class="card-header bg-primary text-white">
                <h3 class="card-title mb-0">Complete Reservation Payment</h3>
            </div>
            <div class="card-body">
                <div class="reservation-details mb-4">
                    <h4>Reservation Details</h4>
                    <table class="table table-striped">
                        <tr>
                            <th>Name:</th>
                            <td>{{ reservation.customer_name }}</td>
                        </tr>
                        <tr>
                            <th>Date:</th>
                            <td>{{ reservation.reservation_date }}</td>
                        </tr>
                        <tr>
                            <th>Time:</th>
                            <td>{{ reservation.reservation_time }}</td>
                        </tr>
                        <tr>
                            <th>Guests:</th>
                            <td>{{ reservation.number_of_guests }}</td>
                        </tr>
                        <tr>
                            <th>Table:</th>
                            <td>{{ reservation.table }}</td>
                        </tr>
                        <tr class="table-primary">
                            <th>Deposit Amount:</th>
                            <td>KSh {{ deposit_amount }}</td>
                        </tr>
                    </table>
                </div>
                
                <div class="payment-instructions alert alert-info">
                    <p><i class="bi bi-info-circle"></i> To confirm your reservation, please pay the deposit amount of <strong>KSh {{ deposit_amount }}</strong> via M-Pesa.</p>
                </div>

                <!-- Payment Status Display -->
                <div id="paymentStatusArea" class="alert alert-warning d-none">
                    <div id="paymentStatusMessage"></div>
                </div>
                
                <div class="d-grid">
                    <button id="mpesaPayButton" class="btn btn-success btn-lg">
                        <i class="bi bi-phone"></i> Pay with M-Pesa
                    </button>
                </div>
            </div>
            <div class="card-footer text-muted">
                <small><i class="bi bi-shield-check"></i> Secured by M-Pesa</small>
            </div>
        </div>
    </div>
</div>

<!-- M-Pesa Modal -->
<div class="modal fade" id="mpesaModal" tabindex="-1" aria-labelledby="mpesaModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="mpesaModalLabel">Complete Payment</h5>
        </div>
        <div class="modal-body text-center">
          <div id="processingPayment">
            <p>Waiting for Mpesa Payment Authorization...</p>
            <p class="text-muted">Please check your phone and enter your M-Pesa PIN when prompted.</p>
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
          </div>
          <div id="paymentError" class="d-none text-danger">
            <i class="bi bi-exclamation-triangle-fill fs-1"></i>
            <p class="error-message mt-3"></p>
            <button class="btn btn-outline-secondary btn-sm mt-2" id="closeModalBtn">Close</button>
          </div>
        </div>
      </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const mpesaPayButton = document.getElementById('mpesaPayButton');
    let mpesaModal;
    
    // Initialize modal
    mpesaPayButton.addEventListener('click', function() {
        // Show the modal
        mpesaModal = new bootstrap.Modal(document.getElementById('mpesaModal'));
        
        // Reset UI elements
        document.getElementById('processingPayment').classList.remove('d-none');
        document.getElementById('paymentError').classList.add('d-none');
        
        mpesaModal.show();
        
        // Send the payment request
        fetch('{% url "mpesa_stk_push" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}',
            },
            body: JSON.stringify({
                phone: '{{ reservation.customer_phone }}',
                amount: {{ deposit_amount }},
                reservation_id: {{ reservation.id }}
            })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response failed');
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                // Check status after a delay to allow processing
                setTimeout(function() {
                    // Redirect to status page
                    window.location.href = '{% url "payment_status" reservation.id %}';
                }, 5000);
            } else {
                // Show error in modal
                document.getElementById('processingPayment').classList.add('d-none');
                document.getElementById('paymentError').classList.remove('d-none');
                
                // Display error message
                const errorMsg = document.querySelector('#paymentError .error-message');
                errorMsg.textContent = data.error || "Payment processing failed. Please try again.";
                
                // Add event listener to close button
                document.getElementById('closeModalBtn').addEventListener('click', function() {
                    mpesaModal.hide();
                });
            }
        })
        .catch(error => {
            console.error('Payment Error:', error);
            
            // Show error in modal
            document.getElementById('processingPayment').classList.add('d-none');
            document.getElementById('paymentError').classList.remove('d-none');
            
            // Display error message
            const errorMsg = document.querySelector('#paymentError .error-message');
            errorMsg.textContent = "Network error. Please check your connection and try again.";
            
            // Add event listener to close button
            document.getElementById('closeModalBtn').addEventListener('click', function() {
                mpesaModal.hide();
            });
        });
    });
});
</script>
{% endblock %}